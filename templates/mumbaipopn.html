<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>A basic map with Leaflet</title>
        <!--source: https://gist.github.com/hpfast/2fb8de57c356d8c45ce511189eec5d6a-->
        <!--add Leaflet CSS-->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
        integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
        crossorigin=""/>
        
        <!--our own style rules-->
        <style type="text/css">
            html, body {
                height: 100%;
                margin: 0;
            }
            #map-container {
                height: 100%;
            }
        </style>

    <style>#map { width: 800px; height: 500px; }
        .info { padding: 6px 8px; font: 14px/16px Arial, Helvetica, sans-serif; background: white; background: rgba(255,255,255,0.8); box-shadow: 0 0 15px rgba(0,0,0,0.2); border-radius: 5px; } .info h4 { margin: 0 0 5px; color: #777; }
        .legend { text-align: left; line-height: 18px; color: #555; } .legend i { width: 18px; height: 18px; float: left; margin-right: 8px; opacity: 0.7; }
    </style>

    </head>
    <body>
        <!--The div in which the map will be created-->
    <div id="map-container"></div>
    
    <!--load leaflet.js-->
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
    integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
    crossorigin=""></script>

    <!--we need the topojson library as well-->
    <script src="https://unpkg.com/topojson@3.0.2/dist/topojson.min.js"></script>
    
    <!--our own code to create the map-->
    <script>
        var mumbai_dict = JSON.parse('{{mumbai_dict | tojson}}');
                
        console.log(mumbai_dict)

      let map = L.map('map-container');
      map.setView([19.1217, 72.8873], 10);
      let bglayer_Positron = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
        subdomains: 'abcd',
        maxZoom: 19
      });
      
      bglayer_Positron.addTo(map);
      var ssp5_2100_e1 = {
        "x-0_y-1_z-3": {
            "url": "https://live.staticflickr.com/65535/53028209306_2a19e504e5_o.png",
            "UL": [
            79.17133464081945,
            -180.0
            ],
            "LR": [
            66.51326044311186,
            -135.0
            ]
        },
        "x-0_y-2_z-3": {
            "url": "https://live.staticflickr.com/65535/53028598055_46d5fc26be_o.png",
            "UL": [
            66.51326044311186,
            -180.0
            ],
            "LR": [
            40.97989806962013,
            -135.0
            ]
        },
        "x-0_y-3_z-3": {
            "url": "https://live.staticflickr.com/65535/53028383054_81d4eb4c40_o.png",
            "UL": [
            40.97989806962013,
            -180.0
            ],
            "LR": [
            0.0,
            -135.0
            ]
        },
        "x-1_y-1_z-3": {
            "url": "https://live.staticflickr.com/65535/53028383019_da4a4172da_o.png",
            "UL": [
            79.17133464081945,
            -135.0
            ],
            "LR": [
            66.51326044311186,
            -90.0
            ]
        },
        "x-1_y-2_z-3": {
            "url": "https://live.staticflickr.com/65535/53028209286_8891e2632b_o.png",
            "UL": [
            66.51326044311186,
            -135.0
            ],
            "LR": [
            40.97989806962013,
            -90.0
            ]
        },
        "x-1_y-3_z-3": {
            "url": "https://live.staticflickr.com/65535/53028209276_a238ea3c10_o.png",
            "UL": [
            40.97989806962013,
            -135.0
            ],
            "LR": [
            0.0,
            -90.0
            ]
        },
        "x-2_y-1_z-3": {
            "url": "https://live.staticflickr.com/65535/53027625147_c84b5d1e55_o.png",
            "UL": [
            79.17133464081945,
            -90.0
            ],
            "LR": [
            66.51326044311186,
            -45.0
            ]
        },
        "x-2_y-2_z-3": {
            "url": "https://live.staticflickr.com/65535/53027625142_25c22fdffe_o.png",
            "UL": [
            66.51326044311186,
            -90.0
            ],
            "LR": [
            40.97989806962013,
            -45.0
            ]
        },
        "x-2_y-3_z-3": {
            "url": "https://live.staticflickr.com/65535/53028598020_922dc30c3f_o.png",
            "UL": [
            40.97989806962013,
            -90.0
            ],
            "LR": [
            0.0,
            -45.0
            ]
        },
        "x-2_y-4_z-3": {
            "url": "https://live.staticflickr.com/65535/53027625132_31092abb6f_o.png",
            "UL": [
            0.0,
            -90.0
            ],
            "LR": [
            -40.97989806962013,
            -45.0
            ]
        },
        "x-2_y-5_z-3": {
            "url": "https://live.staticflickr.com/65535/53028209281_0cb3e182fb_o.png",
            "UL": [
            -40.97989806962013,
            -90.0
            ],
            "LR": [
            -66.51326044311186,
            -45.0
            ]
        },
        "x-3_y-1_z-3": {
            "url": "https://live.staticflickr.com/65535/53028382984_243d97fa3a_o.png",
            "UL": [
            79.17133464081945,
            -45.0
            ],
            "LR": [
            66.51326044311186,
            0.0
            ]
        },
        "x-3_y-2_z-3": {
            "url": "https://live.staticflickr.com/65535/53028382989_bc54d17bfa_o.png",
            "UL": [
            66.51326044311186,
            -45.0
            ],
            "LR": [
            40.97989806962013,
            0.0
            ]
        },
        "x-3_y-3_z-3": {
            "url": "https://live.staticflickr.com/65535/53028695588_a83325726c_o.png",
            "UL": [
            40.97989806962013,
            -45.0
            ],
            "LR": [
            0.0,
            0.0
            ]
        },
        "x-3_y-4_z-3": {
            "url": "https://live.staticflickr.com/65535/53028597935_6d37e9afd7_o.png",
            "UL": [
            0.0,
            -45.0
            ],
            "LR": [
            -40.97989806962013,
            0.0
            ]
        },
        "x-4_y-1_z-3": {
            "url": "https://live.staticflickr.com/65535/53028209216_a0b4f2e581_o.png",
            "UL": [
            79.17133464081945,
            0.0
            ],
            "LR": [
            66.51326044311186,
            45.0
            ]
        },
        "x-4_y-2_z-3": {
            "url": "https://live.staticflickr.com/65535/53028597925_cb2eea632b_o.png",
            "UL": [
            66.51326044311186,
            0.0
            ],
            "LR": [
            40.97989806962013,
            45.0
            ]
        },
        "x-4_y-3_z-3": {
            "url": "https://live.staticflickr.com/65535/53028209146_7e540c5111_o.png",
            "UL": [
            40.97989806962013,
            0.0
            ],
            "LR": [
            0.0,
            45.0
            ]
        },
        "x-4_y-4_z-3": {
            "url": "https://live.staticflickr.com/65535/53028209131_057e88f49b_o.png",
            "UL": [
            0.0,
            0.0
            ],
            "LR": [
            -40.97989806962013,
            45.0
            ]
        },
        "x-5_y-1_z-3": {
            "url": "https://live.staticflickr.com/65535/53028597885_e5083cbf07_o.png",
            "UL": [
            79.17133464081945,
            45.0
            ],
            "LR": [
            66.51326044311186,
            90.0
            ]
        },
        "x-5_y-2_z-3": {
            "url": "https://live.staticflickr.com/65535/53028209136_83e8b9d39a_o.png",
            "UL": [
            66.51326044311186,
            45.0
            ],
            "LR": [
            40.97989806962013,
            90.0
            ]
        },
        "x-5_y-3_z-3": {
            "url": "https://live.staticflickr.com/65535/53028695528_f43846c42d_o.png",
            "UL": [
            40.97989806962013,
            45.0
            ],
            "LR": [
            0.0,
            90.0
            ]
        },
        "x-5_y-4_z-3": {
            "url": "https://live.staticflickr.com/65535/53027625082_20dc53c3d1_o.png",
            "UL": [
            0.0,
            45.0
            ],
            "LR": [
            -40.97989806962013,
            90.0
            ]
        },
        "x-6_y-1_z-3": {
            "url": "https://live.staticflickr.com/65535/53028382939_2f14ab785d_o.png",
            "UL": [
            79.17133464081945,
            90.0
            ],
            "LR": [
            66.51326044311186,
            135.0
            ]
        },
        "x-6_y-2_z-3": {
            "url": "https://live.staticflickr.com/65535/53027625032_f15eb1e7d0_o.png",
            "UL": [
            66.51326044311186,
            90.0
            ],
            "LR": [
            40.97989806962013,
            135.0
            ]
        },
        "x-6_y-3_z-3": {
            "url": "https://live.staticflickr.com/65535/53028382889_7e6b69bd8d_o.png",
            "UL": [
            40.97989806962013,
            90.0
            ],
            "LR": [
            0.0,
            135.0
            ]
        },
        "x-6_y-4_z-3": {
            "url": "https://live.staticflickr.com/65535/53028597850_126701364d_o.png",
            "UL": [
            0.0,
            90.0
            ],
            "LR": [
            -40.97989806962013,
            135.0
            ]
        },
        "x-7_y-1_z-3": {
            "url": "https://live.staticflickr.com/65535/53028597840_7028956860_o.png",
            "UL": [
            79.17133464081945,
            135.0
            ],
            "LR": [
            66.51326044311186,
            180.0
            ]
        },
        "x-7_y-2_z-3": {
            "url": "https://live.staticflickr.com/65535/53028382874_8bbab93587_o.png",
            "UL": [
            66.51326044311186,
            135.0
            ],
            "LR": [
            40.97989806962013,
            180.0
            ]
        },
        "x-7_y-3_z-3": {
            "url": "https://live.staticflickr.com/65535/53028597820_d045b0610b_o.png",
            "UL": [
            40.97989806962013,
            135.0
            ],
            "LR": [
            0.0,
            180.0
            ]
        },
        "x-7_y-4_z-3": {
            "url": "https://live.staticflickr.com/65535/53028695453_3bf4b5837c_o.png",
            "UL": [
            0.0,
            135.0
            ],
            "LR": [
            -40.97989806962013,
            180.0
            ]
        },
        "x-7_y-5_z-3": {
            "url": "https://live.staticflickr.com/65535/53028209066_a9d3bac04c_o.png",
            "UL": [
            -40.97989806962013,
            135.0
            ],
            "LR": [
            -66.51326044311186,
            180.0
            ]
        }
        };
        
        var imageoverlays = {};
        for (var xyz in ssp5_2100_e1) {
          var swlat = ssp5_2100_e1[xyz]['LR'][0];
          var swlong = ssp5_2100_e1[xyz]['UL'][1];
          var nelat = ssp5_2100_e1[xyz]['UL'][0];
          var nelong = ssp5_2100_e1[xyz]['LR'][1];
          const latLngBounds = L.latLngBounds([[nelat, nelong], [swlat, swlong]]);
          var imageUrl = ssp5_2100_e1[xyz]["url"];
          var layer = L.imageOverlay(imageUrl, latLngBounds).addTo(map);
          imageoverlays[xyz] = layer;
          // var swlat = -40.97989806962013;//18.877702;
          // var swlong = 90;//72.671814;
          // var nelat = 0;//19.339653;
          // var nelong = 135.0;//73.048096;
          // const latLngBounds = L.latLngBounds([[nelat, nelong], [swlat, swlong]]);
          // var imageUrl = "https://live.staticflickr.com/65535/53028597850_126701364d_o.png";
          // // var imageUrl = 'https://sedac.ciesin.columbia.edu/geoserver/wms?service=WMS&request=GetMap&layers=popdynamics%3Apopdynamics-pop-projection-ssp-2010-2100_ssp5-2100-total-population%2Ccartographic%3A00-global-labels&styles=&format=image%2Fpng&transparent=true&version=1.1.1&width=256&height=256&srs=EPSG%3A3857&bbox=10018754,-5009377,15028131,0';
          // L.imageOverlay(imageUrl, latLngBounds).addTo(map);
        }

        for (var xyz in ssp5_2100_e1) {
          map.removeLayer(imageoverlays[xyz]);
        }


      flood_img = "https://live.staticflickr.com/6020/5983874743_c566cc1c5c_k.jpg";
      const flood_icon = L.icon({
                    iconUrl: flood_img,
                    iconSize: [32, 37],
                    iconAnchor: [16, 37],
                    popupAnchor: [0, -28]
                });
        
      L.marker([0,0], {icon: flood_icon}).addTo(map);

      // control that shows state info on hover
    const info = L.control();

    info.onAdd = function (map) {
        this._div = L.DomUtil.create('div', 'info');
        this.update();
        return this._div;
    };

    info.update = function (props) {
        const contents = props ? `<b>${mumbai_dict[props.name].Ward_Names}</b><br />${mumbai_dict[props.name].TOT_P_DEN} people / km<sup>2</sup> (2011)` : 'Hover over a ward';
        this._div.innerHTML = `<h4>Mumbai Population Density</h4>${contents}`;
    };

    info.addTo(map);

    // get color depending on population density value
    function getColor(d) {
        return d > 90000 ? '#800026' :
            d > 50000  ? '#BD0026' :
            d > 40000  ? '#E31A1C' :
            d > 30000  ? '#FC4E2A' :
            d > 20000   ? '#FD8D3C' :
            d > 10000   ? '#FEB24C' :
            d > 5000   ? '#FED976' :
                        '#FFEDA0';
    };

      //extend Leaflet to create a GeoJSON layer from a TopoJSON file
      L.TopoJSON = L.GeoJSON.extend({
        addData: function (data) {
          var geojson, key;
          if (data.type === "Topology") {
            for (key in data.objects) {
              if (data.objects.hasOwnProperty(key)) {
                geojson = topojson.feature(data, data.objects[key]);
                L.GeoJSON.prototype.addData.call(this, geojson);
              }
            }
            return this;
          }
          L.GeoJSON.prototype.addData.call(this, data);
          return this;
        }
      });

      

      L.topoJson = function (data, options) {
        return new L.TopoJSON(data, options);
      };
    
    // mouseover events
    function highlightFeature(e) {
		const layer = e.target;

		layer.setStyle({
			weight: 5,
			color: '#666',
			dashArray: '',
			fillOpacity: 0.7
		});

		layer.bringToFront();

		info.update(layer.feature.properties);
	}

    function resetHighlight(e) {
		geojson.resetStyle(e.target);
		info.update();
	}

	function zoomToFeature(e) {
		map.fitBounds(e.target.getBounds());
	}

      //create an empty geojson layer, 
      //create a different style for each individual feature
      //with a style and a popup on click
      var geojson = L.topoJson(null, {
        style: function(feature){
          return {
            color: "#000",
            opacity: 1,
            weight: 1,
            //fillColor: getColor(feature.properties.density),
            fillColor: getColor(mumbai_dict[feature.properties.name].TOT_P_DEN),
            fillOpacity: 0.8
          }
        },
        //The onEachFeature option is a function that gets called on each feature before adding it to a GeoJSON layer. 
        //A common reason to use this option is to attach a popup to features when they are clicked.
        onEachFeature: function(feature, layer) {
            layer.on({
                mouseover: highlightFeature,
                mouseout: resetHighlight,
                click: zoomToFeature
            });
          //layer.bindPopup('<p>'+feature.properties.name+'</p>')
          //layer.bindPopup('<p>'+mumbai_dict[feature.properties.name].Ward_Names+'</p>')
        }
      }).addTo(map);
      //fill: #317581;
      //define a function to get and parse geojson from URL
      async function getGeoData(url) {
        let response = await fetch(url);
        let data = await response.json();
        console.log(data)
        return data;
      }
      
      //fetch the geojson and add it to our geojson layer
      getGeoData('https://gist.githubusercontent.com/mickeykedia/9d9144072c5f637c26995569dd347614/raw/b65134846607235adf4ad6498713deed77d3b4b5/Mumbai_Topojson.topojson').then(data => geojson.addData(data));
    
    // add legend
    const legend = L.control({position: 'bottomright'});

	legend.onAdd = function (map) {

		const div = L.DomUtil.create('div', 'info legend');
		const grades = [0, 5000, 10000, 20000, 30000, 40000, 50000, 90000];
		const labels = [];
		let from, to;

		for (let i = 0; i < grades.length; i++) {
			from = grades[i];
			to = grades[i + 1];

			labels.push(`<i style="background:${getColor(from + 1)}"></i> ${from}${to ? `&ndash;${to}` : '+'}`);
		}

		div.innerHTML = labels.join('<br>');
		return div;
	};

	legend.addTo(map);

    </script>

        
    </body>
</html>